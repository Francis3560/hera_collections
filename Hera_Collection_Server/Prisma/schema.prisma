generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  USER
  ADMIN
}

enum AuthProvider {
  EMAIL
  GOOGLE
}

enum OrderStatus {
  PENDING
  PAID
  FULFILLED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}

enum PaymentMethod {
  MPESA
  CARD
  CASH
  OTHER
}

enum StockMovementType {
  ADDITION
  ADJUSTMENT
  SALE
  RETURN
  DAMAGE
  LOSS
  TRANSFER
  CORRECTION
}

enum UserStatus {
  ONLINE
  OFFLINE
  AWAY
  BUSY
}

enum NotificationType {
  ORDER_PLACED
  ORDER_CANCELLED
  ORDER_FULFILLED
  PAYMENT_SUCCESS
  PAYMENT_FAILED
  STOCK_LOW
  STOCK_OUT
  SYSTEM_ALERT
  PROMOTION
  MESSAGE
}

model User {
  id       Int          @id @default(autoincrement())
  email    String       @unique @db.VarChar(191)
  name     String?      @db.VarChar(120)
  phone    String?      @db.VarChar(32)
  role     Role         @default(USER)
  provider AuthProvider @default(EMAIL)

  // Google OAuth fields
  googleId                    String?    @unique @db.VarChar(255)
  picture                     String?    @db.VarChar(512)
  givenName                   String?    @db.VarChar(120)
  familyName                  String?    @db.VarChar(120)
  locale                      String?    @db.VarChar(10)
  emailVerifiedByGoogle       Boolean    @default(false)
  status                      UserStatus @default(OFFLINE)
  passwordHash                String?    @db.VarChar(255)
  lastSeen                    DateTime?
  lastPasswordChange          DateTime?
  isVerified                  Boolean    @default(false)
  verificationCode            String?    @db.VarChar(6)
  verificationCodeExpires     DateTime? // Add this back if needed
  verificationCodeExpiresUnix BigInt?    @db.BigInt
  passwordResetToken          String?    @db.VarChar(255)
  passwordResetExpires        DateTime?

  loginAttempts          Int             @default(0)
  lockedUntil            DateTime?
  twoFactorEnabled       Boolean         @default(false)
  twoFactorSecret        String?         @db.VarChar(255)
  backupCodes            String?         @db.Text
  bio                    String?         @db.Text
  location               String?         @db.VarChar(120)
  website                String?         @db.VarChar(255)
  dateOfBirth            DateTime?
  emailNotifications     Boolean         @default(true)
  smsNotifications       Boolean         @default(false)
  marketingEmails        Boolean         @default(false)
  language               String          @default("en") @db.VarChar(10)
  timezone               String          @default("UTC") @db.VarChar(50)
  products               Product[]
  orders                 Order[]
  paymentIntents         PaymentIntent[]
  messagesSent           Message[]       @relation("MessagesSent")
  messagesReceived       Message[]       @relation("MessagesReceived")
  expenses               Expense[]
  stockMovements         StockMovement[]
  createdStockTakes      StockTake[]     @relation("StockTakeCreator")
  approvedStockTakes     StockTake[]     @relation("StockTakeApprover")
  resolvedStockAlerts    StockAlert[]    @relation("StockAlertResolver")
  adjustedStockTakeItems StockTakeItem[] @relation("StockTakeItemAdjuster")
  sessions               Session[]
  refreshTokens          RefreshToken[]
  reviews                Review[] // Added: Reviews by user
  wishlistItems          WishlistItem[] // Added: User's wishlist items
  addresses              Address[] // Added: User's addresses
  activityLogs           ActivityLog[] // Added: User's activity logs
  cart                   Cart? // Added: User's shopping cart
  notifications          Notification[] // Added: User's notifications
  createdAt              DateTime        @default(now())
  updatedAt              DateTime        @updatedAt
  deletedAt              DateTime? // Soft delete

  @@index([role])
  @@index([googleId])
  @@index([isVerified])
  @@index([createdAt])
  @@index([provider])
  @@index([status])
  @@index([email])
  @@index([phone])
  @@index([deletedAt])
}

model Session {
  id           String   @id @default(uuid())
  userId       Int
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken  String   @db.VarChar(512)
  refreshToken String?  @db.VarChar(512)
  userAgent    String?  @db.Text
  ipAddress    String?  @db.VarChar(45)
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
  @@index([accessToken])
  @@index([expiresAt])
}

model RefreshToken {
  id              String    @id @default(uuid())
  userId          Int
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  token           String    @unique @db.VarChar(512)
  expiresAt       DateTime
  revoked         Boolean   @default(false)
  revokedAt       DateTime?
  replacedByToken String?   @db.VarChar(512)
  userAgent       String?   @db.Text
  ipAddress       String?   @db.VarChar(45)
  createdAt       DateTime  @default(now())

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@index([revoked])
}

model Product {
  id          Int     @id @default(autoincrement())
  title       String  @db.VarChar(160)
  description String? @db.Text
  isPublished Boolean @default(true)

  // Relations
  category       Category?        @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  categoryId     Int?
  seller         User             @relation(fields: [sellerId], references: [id], onDelete: Restrict)
  sellerId       Int
  photos         Photo[]
  options        ProductOption[]
  variants       ProductVariant[]
  orderItems     OrderItem[] // Back-reference for items linked directly to product if needed, but usually variants
  messages       Message[]
  reviews        Review[] // Product reviews
  wishlistItems  WishlistItem[] // Product in wishlists
  cartItems      CartItem[] // Added: Items in carts (back-relation)
  couponProducts Coupon[]         @relation("CouponProducts") // Coupons applicable to this product

  // Metadata
  // Metadata
  brand        String? @db.VarChar(120)
  manufacturer String? @db.VarChar(120)

  // SEO
  slug            String  @unique @db.VarChar(200)
  metaTitle       String? @db.VarChar(160)
  metaDescription String? @db.VarChar(255)

  // Statistics
  views       Int      @default(0)
  purchases   Int      @default(0)
  rating      Decimal? @db.Decimal(3, 2)
  reviewCount Int      @default(0)

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  publishedAt DateTime?

  @@index([title])
  @@index([categoryId])
  @@index([sellerId])
  @@index([isPublished])
  @@index([createdAt])
  @@index([slug])
  @@index([rating])
  discounts Discount[] @relation("ProductDiscounts")
}

model Discount {
  id                 Int       @id @default(autoincrement())
  name               String    @db.VarChar(120)
  description        String?   @db.Text
  discountPercentage Decimal   @db.Decimal(5, 2)
  startDate          DateTime
  endDate            DateTime
  isActive           Boolean   @default(true)
  products           Product[] @relation("ProductDiscounts")
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  @@index([isActive])
  @@index([startDate, endDate])
}

model Category {
  id               Int        @id @default(autoincrement())
  name             String     @unique @db.VarChar(120)
  slug             String     @unique @db.VarChar(160)
  description      String?    @db.Text
  coverPhoto       String?    @db.VarChar(512)
  parentId         Int?
  parent           Category?  @relation("CategoryToCategory", fields: [parentId], references: [id], onDelete: SetNull)
  children         Category[] @relation("CategoryToCategory")
  products         Product[]
  couponCategories Coupon[]   @relation("CouponCategories") // Coupons applicable to this category
  order            Int        @default(0)
  isActive         Boolean    @default(true)
  createdAt        DateTime   @default(now())
  updatedAt        DateTime   @updatedAt

  @@index([parentId])
  @@index([slug])
  @@index([order])
  @@index([isActive])
}

model Photo {
  id        Int      @id @default(autoincrement())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId Int
  url       String   @db.VarChar(512)
  publicId  String?  @db.VarChar(255)
  altText   String?  @db.VarChar(255)
  isPrimary Boolean  @default(false)
  order     Int      @default(0)
  createdAt DateTime @default(now())

  @@index([productId])
  @@index([isPrimary])
  @@index([order])
}

model ProductOption {
  id        Int     @id @default(autoincrement())
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId Int
  name      String  @db.VarChar(120) // e.g., "Color", "Size"

  values OptionValue[]

  @@unique([productId, name])
  @@index([productId])
}

model OptionValue {
  id              Int           @id @default(autoincrement())
  option          ProductOption @relation(fields: [productOptionId], references: [id], onDelete: Cascade)
  productOptionId Int
  value           String        @db.VarChar(120) // e.g., "Black", "XL"

  variants VariantOptionValue[]

  @@unique([productOptionId, value])
  @@index([productOptionId])
}

model ProductVariant {
  id        Int      @id @default(autoincrement())
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId Int
  sku       String   @unique @db.VarChar(64)
  price     Decimal  @db.Decimal(10, 2)
  costPrice Decimal? @db.Decimal(10, 2)
  stock     Int      @default(0)
  image     String?  @db.VarChar(512)
  isActive  Boolean  @default(true)

  optionValues   VariantOptionValue[]
  wishlistItems  WishlistItem[]
  orderItems     OrderItem[]
  cartItems      CartItem[] // Added: Items in carts (back-relation)
  stockMovements StockMovement[]
  stockAlerts    StockAlert[]
  stockTakeItems StockTakeItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
  @@index([sku])
  @@index([isActive])
}

model VariantOptionValue {
  variant       ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  variantId     Int
  optionValue   OptionValue    @relation(fields: [optionValueId], references: [id], onDelete: Cascade)
  optionValueId Int

  @@id([variantId, optionValueId])
  @@index([variantId])
  @@index([optionValueId])
}

model Review {
  id         Int      @id @default(autoincrement())
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId  Int
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     Int
  rating     Int      @default(5)
  title      String?  @db.VarChar(160)
  comment    String?  @db.Text
  isVerified Boolean  @default(false) // Verified purchase
  helpful    Int      @default(0)
  notHelpful Int      @default(0)
  isApproved Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([productId, userId])
  @@index([productId])
  @@index([userId])
  @@index([rating])
  @@index([createdAt])
}

model WishlistItem {
  id        Int             @id @default(autoincrement())
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int
  product   Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId Int
  variantId Int?
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  createdAt DateTime        @default(now())

  @@unique([userId, productId, variantId])
  @@index([userId])
  @@index([productId])
}

model Order {
  id          Int    @id @default(autoincrement())
  orderNumber String @unique @db.VarChar(32)

  // Customer information
  buyer             User    @relation(fields: [buyerId], references: [id], onDelete: Restrict)
  buyerId           Int
  customerFirstName String? @db.VarChar(120)
  customerLastName  String? @db.VarChar(120)
  customerEmail     String? @db.VarChar(191)
  customerPhone     String? @db.VarChar(32)

  // Shipping information
  shippingAddress   String?   @db.Text
  shippingCity      String?   @db.VarChar(120)
  shippingState     String?   @db.VarChar(120)
  shippingCountry   String?   @db.VarChar(120)
  shippingZipCode   String?   @db.VarChar(20)
  shippingMethod    String?   @db.VarChar(100)
  shippingCost      Decimal   @default(0) @db.Decimal(10, 2)
  estimatedDelivery DateTime?
  trackingNumber    String?   @db.VarChar(100)
  carrier           String?   @db.VarChar(100)

  // Billing information
  billingAddress String? @db.Text
  billingCity    String? @db.VarChar(120)
  billingState   String? @db.VarChar(120)
  billingCountry String? @db.VarChar(120)
  billingZipCode String? @db.VarChar(20)

  // Order details
  status         OrderStatus   @default(PENDING)
  paymentMethod  PaymentMethod @default(MPESA)
  subtotalAmount Decimal       @db.Decimal(10, 2)
  taxAmount      Decimal       @default(0) @db.Decimal(10, 2)
  discountAmount Decimal       @default(0) @db.Decimal(10, 2)
  totalAmount    Decimal       @db.Decimal(10, 2)
  currency       String        @default("KES") @db.VarChar(3)

  // Payment
  paymentIntent   PaymentIntent? @relation(fields: [paymentIntentId], references: [id])
  paymentIntentId Int?           @unique
  paidAt          DateTime?

  // Notes and metadata
  notes         String? @db.Text
  internalNotes String? @db.Text
  customerNotes String? @db.Text

  // Relations
  items     OrderItem[]
  shipments Shipment[] // Multiple shipments

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  cancelledAt DateTime?

  @@index([buyerId])
  @@index([status])
  @@index([createdAt])
  @@index([orderNumber])
  @@index([customerEmail])
  @@index([paymentIntentId])
}

model Cart {
  id        Int        @id @default(autoincrement())
  user      User?      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int?       @unique
  sessionId String?    @unique @db.VarChar(128)
  items     CartItem[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@index([userId])
  @@index([sessionId])
}

model CartItem {
  id           Int             @id @default(autoincrement())
  cart         Cart            @relation(fields: [cartId], references: [id], onDelete: Cascade)
  cartId       Int
  product      Product         @relation(fields: [productId], references: [id], onDelete: Restrict)
  productId    Int
  variant      ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  variantId    Int?
  quantity     Int             @default(1)
  variantName  String?         @db.VarChar(120)
  variantValue String?         @db.VarChar(120)


  @@index([cartId])
  @@index([productId])
  @@index([variantId])
}

model Shipment {
  id                Int       @id @default(autoincrement())
  order             Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId           Int
  trackingNumber    String    @unique @db.VarChar(100)
  carrier           String    @db.VarChar(100)
  method            String    @db.VarChar(100)
  status            String    @default("PENDING") // PENDING, SHIPPED, DELIVERED, FAILED
  shippedAt         DateTime?
  deliveredAt       DateTime?
  estimatedDelivery DateTime?
  notes             String?   @db.Text
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([orderId])
  @@index([trackingNumber])
  @@index([status])
}

model OrderItem {
  id           Int             @id @default(autoincrement())
  order        Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId      Int
  product      Product         @relation(fields: [productId], references: [id], onDelete: Restrict)
  productId    Int
  variantId    Int?
  variant      ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  variantName  String?         @db.VarChar(120)
  variantValue String?         @db.VarChar(120)
  quantity     Int             @default(1)
  price        Decimal         @db.Decimal(10, 2)
  discount     Decimal?        @db.Decimal(10, 2)
  total        Decimal         @db.Decimal(10, 2)
  createdAt    DateTime        @default(now())

  @@index([orderId])
  @@index([productId])
  @@index([variantId])
}

model PaymentIntent {
  id      Int    @id @default(autoincrement())
  buyer   User   @relation(fields: [buyerId], references: [id], onDelete: Cascade)
  buyerId Int
  order   Order?

  method                 PaymentMethod @default(MPESA)
  mpesaCheckoutRequestId String?       @unique @db.VarChar(64)
  mpesaMerchantRequestId String?       @db.VarChar(64)
  phone                  String?       @db.VarChar(32)

  // Card payment fields
  cardLastFour    String? @db.VarChar(4)
  cardBrand       String? @db.VarChar(50)
  cardExpiryMonth Int?
  cardExpiryYear  Int?

  amount   Decimal       @db.Decimal(10, 2)
  currency String        @default("KES") @db.VarChar(3)
  status   PaymentStatus @default(PENDING)

  // Metadata
  payload      String? @db.Text
  errorMessage String? @db.Text
  receiptUrl   String? @db.VarChar(512)

  // Timestamps
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  paidAt    DateTime?

  @@index([buyerId])
  @@index([status])
  @@index([createdAt])
  @@index([mpesaCheckoutRequestId])
}

model Message {
  id         Int       @id @default(autoincrement())
  fromUser   User      @relation("MessagesSent", fields: [fromUserId], references: [id], onDelete: Cascade)
  fromUserId Int
  toUser     User      @relation("MessagesReceived", fields: [toUserId], references: [id], onDelete: Cascade)
  toUserId   Int
  product    Product?  @relation(fields: [productId], references: [id], onDelete: SetNull)
  productId  Int?
  body       String    @db.Text
  isRead     Boolean   @default(false)
  readAt     DateTime?
  createdAt  DateTime  @default(now())

  @@index([toUserId, createdAt])
  @@index([fromUserId, createdAt])
  @@index([productId])
  @@index([isRead])
}

model ExpenseCategory {
  id          Int       @id @default(autoincrement())
  name        String    @unique @db.VarChar(120)
  description String?   @db.Text
  color       String?   @db.VarChar(7)
  icon        String?   @db.VarChar(50)
  expenses    Expense[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Expense {
  id          Int      @id @default(autoincrement())
  title       String   @db.VarChar(160)
  description String?  @db.Text
  amount      Decimal  @db.Decimal(10, 2)
  date        DateTime @default(now())

  category   ExpenseCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  categoryId Int?

  createdBy   User @relation(fields: [createdById], references: [id], onDelete: Restrict)
  createdById Int

  paymentMethod   PaymentMethod @default(CASH)
  referenceNumber String?       @unique @db.VarChar(64)
  receiptUrl      String?       @db.VarChar(512)
  status          String        @default("ACTIVE") // ACTIVE, CANCELLED, REFUNDED

  // Recurring expense
  isRecurring    Boolean   @default(false)
  recurrence     String?   @db.VarChar(50) // DAILY, WEEKLY, MONTHLY, YEARLY
  nextOccurrence DateTime?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryId])
  @@index([createdById])
  @@index([date])
  @@index([status])
  @@index([isRecurring])
}

model StockMovement {
  id        Int            @id @default(autoincrement())
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  variantId Int

  movementType StockMovementType
  quantity     Int
  unitCost     Decimal?          @db.Decimal(10, 2)

  previousStock Int
  newStock      Int

  referenceId   Int?
  referenceType String? @db.VarChar(50) // ORDER, STOCK_TAKE, ADJUSTMENT, etc.

  reason String? @db.Text
  notes  String? @db.Text

  createdBy   User @relation(fields: [createdById], references: [id], onDelete: Restrict)
  createdById Int

  location     String?  @db.VarChar(120)
  costPrice    Decimal? @db.Decimal(10, 2)
  sellingPrice Decimal? @db.Decimal(10, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([variantId])
  @@index([movementType])
  @@index([createdAt])
  @@index([referenceId, referenceType])
}

model StockAlert {
  id        Int            @id @default(autoincrement())
  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Cascade)
  variantId Int

  threshold Int     @default(10)
  isActive  Boolean @default(true)

  notifiedAt      DateTime?
  isResolved      Boolean   @default(false)
  resolvedAt      DateTime?
  resolvedBy      User?     @relation("StockAlertResolver", fields: [resolvedById], references: [id], onDelete: SetNull)
  resolvedById    Int?
  resolutionNotes String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([variantId])
  @@index([isActive])
  @@index([isResolved])
}

model StockTake {
  id          Int     @id @default(autoincrement())
  title       String  @db.VarChar(160)
  description String? @db.Text

  status String @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED, CANCELLED

  startDate   DateTime?
  endDate     DateTime?
  completedAt DateTime?

  totalItems    Int @default(0)
  itemsCounted  Int @default(0)
  itemsAdjusted Int @default(0)

  discrepancyValue      Decimal? @db.Decimal(10, 2)
  discrepancyPercentage Decimal? @db.Decimal(5, 2)

  createdBy   User @relation("StockTakeCreator", fields: [createdById], references: [id], onDelete: Restrict)
  createdById Int

  approvedBy   User? @relation("StockTakeApprover", fields: [approvedById], references: [id], onDelete: SetNull)
  approvedById Int?

  location String? @db.VarChar(120)
  notes    String? @db.Text

  items StockTakeItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([createdAt])
  @@index([createdById])
  @@index([approvedById])
}

model StockTakeItem {
  id          Int       @id @default(autoincrement())
  stockTake   StockTake @relation(fields: [stockTakeId], references: [id], onDelete: Cascade)
  stockTakeId Int

  variant   ProductVariant @relation(fields: [variantId], references: [id], onDelete: Restrict)
  variantId Int

  systemQuantity     Int
  countedQuantity    Int
  difference         Int
  variancePercentage Decimal? @db.Decimal(5, 2)

  adjusted     Boolean   @default(false)
  adjustedAt   DateTime?
  adjustedBy   User?     @relation("StockTakeItemAdjuster", fields: [adjustedById], references: [id], onDelete: SetNull)
  adjustedById Int?

  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([stockTakeId, variantId])
  @@index([variantId])
  @@index([difference])
  @@index([adjusted])
}

model Address {
  id           Int      @id @default(autoincrement())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId       Int
  type         String   @default("SHIPPING") // SHIPPING, BILLING
  firstName    String   @db.VarChar(120)
  lastName     String   @db.VarChar(120)
  company      String?  @db.VarChar(120)
  addressLine1 String   @db.VarChar(255)
  addressLine2 String?  @db.VarChar(255)
  city         String   @db.VarChar(120)
  state        String?  @db.VarChar(120)
  country      String   @db.VarChar(120)
  zipCode      String   @db.VarChar(20)
  phone        String   @db.VarChar(32)
  isDefault    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
  @@index([type])
  @@index([isDefault])
}

model Coupon {
  id             Int        @id @default(autoincrement())
  code           String     @unique @db.VarChar(50)
  type           String     @default("PERCENTAGE") // PERCENTAGE, FIXED_AMOUNT, FREE_SHIPPING
  value          Decimal    @db.Decimal(10, 2)
  minOrderAmount Decimal?   @db.Decimal(10, 2)
  maxDiscount    Decimal?   @db.Decimal(10, 2)
  usageLimit     Int?
  usedCount      Int        @default(0)
  startDate      DateTime?
  endDate        DateTime?
  isActive       Boolean    @default(true)
  singleUse      Boolean    @default(false)
  products       Product[]  @relation("CouponProducts")
  categories     Category[] @relation("CouponCategories")
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  @@index([code])
  @@index([isActive])
  @@index([startDate])
  @@index([endDate])
}

model NewsletterSubscriber {
  id             Int       @id @default(autoincrement())
  email          String    @unique @db.VarChar(191)
  name           String?   @db.VarChar(120)
  isActive       Boolean   @default(true)
  subscribedAt   DateTime  @default(now())
  unsubscribedAt DateTime?
  source         String?   @db.VarChar(50) // WEBSITE, CHECKOUT, MANUAL
  tags           String?   @db.Text // Comma-separated tags
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@index([email])
  @@index([isActive])
  @@index([subscribedAt])
}

model ActivityLog {
  id         Int      @id @default(autoincrement())
  userId     Int?
  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  action     String   @db.VarChar(100)
  entityType String   @db.VarChar(50)
  entityId   Int?
  oldValue   String?  @db.Text
  newValue   String?  @db.Text
  ipAddress  String?  @db.VarChar(45)
  userAgent  String?  @db.Text
  metadata   String?  @db.Text
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([createdAt])
}

model Notification {
  id          Int              @id @default(autoincrement())
  userId      Int
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type        NotificationType
  title       String           @db.VarChar(160)
  message     String           @db.Text
  isRead      Boolean          @default(false)
  
  // Optional dynamic fields
  link        String?          @db.VarChar(255) // Link to redirect to
  entityId    String?          @db.VarChar(64)  // Related entity ID (orderId, etc.)
  entityType  String?          @db.VarChar(50)  // Related entity type
  
  // Custom data
  metadata    String?          @db.Text         // JSON metadata
  
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([userId])
  @@index([type])
  @@index([isRead])
  @@index([createdAt])
}
